@model DAL.Entities.Cart

@{
    ViewData["Title"] = "Giỏ hàng của bạn";
}

<div class="cart-page">
    <!-- Header -->
    <div class="cart-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="cart-title">
                    <i class="bi bi-cart3"></i> Giỏ hàng của bạn
                </h1>
                @if (Model != null && Model.CartItems.Any())
                {
                    <p class="cart-subtitle">Bạn có @Model.CartItems.Count sản phẩm trong giỏ</p>
                }
            </div>
            <a asp-controller="Order" asp-action="Index" class="btn btn-outline-primary">
                <i class="bi bi-receipt me-2"></i> Đơn hàng của tôi
            </a>
        </div>
    </div>

    @if (Model == null)
    {
        <div class="empty-cart">
            <div class="empty-cart-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h3>Cart = null (chưa tạo cart cho user)</h3>
        </div>
    }
    else if (!Model.CartItems.Any())
    {
        <!-- Empty Cart State -->
        <div class="empty-cart">
            <div class="empty-cart-icon">
                <i class="bi bi-cart-x"></i>
            </div>
            <h3>Giỏ hàng trống</h3>
            <p>Hãy thêm sản phẩm vào giỏ để tiếp tục mua sắm</p>
            <a asp-controller="Shop" asp-action="Index" class="btn btn-primary btn-lg">
                <i class="bi bi-bag-plus me-2"></i> Khám phá sản phẩm
            </a>
        </div>
    }
    else
    {
        @* ✅ GIỮ NGUYÊN: Single antiforgery token for JS *@
        <div id="afToken" style="display:none;">
            @Html.AntiForgeryToken()
        </div>

        <div class="row g-4">
            <!-- Cart Items (Left Column) -->
            <div class="col-lg-8">
                <div class="cart-items">
                    @foreach (var item in Model.CartItems)
                    {
                        <div class="cart-item">
                            <!-- Product Image -->
                            <div class="cart-item-image">
                                @{
                                    var img = item.Product?.Image;
                                }

                                @if (!string.IsNullOrEmpty(img))
                                {
                                    <img src="@Url.Content(img)" alt="@item.Product.ProductName" />
                                }
                                else
                                {
                                    <div class="no-image"><i class="bi bi-image"></i></div>
                                }
                            </div>


                            <!-- Product Info -->
                            <div class="cart-item-info">
                                <h5 class="cart-item-name">@item.Product.ProductName</h5>
                                <p class="cart-item-sku">SKU: @(item.Product.Sku ?? "N/A")</p>

                                @* ✅ GIỮ NGUYÊN: data-unitprice using invariant format so JS can parse reliably *@
                                <div class="cart-item-price" data-unitprice="@(item.UnitPrice.ToString(System.Globalization.CultureInfo.InvariantCulture))">
                                    <span class="price-label">Đơn giá:</span>
                                    <span class="price">@item.UnitPrice.ToString("N0")₫</span>
                                </div>
                            </div>

                            <!-- Actions Column -->
                            <div class="cart-item-actions">
                                <!-- Quantity Controls -->
                                <div class="quantity-section">
                                    <label class="qty-label">Số lượng:</label>
                                    <div class="quantity-control">
                                        <button type="button" class="qty-btn qty-minus" data-cartitemid="@item.CartItemId">
                                            <i class="bi bi-dash"></i>
                                        </button>

                                        @* ✅ GIỮ NGUYÊN: Inline numeric input — no submit button. JS will POST to Cart/Update *@
                                        <input type="number"
                                               min="1"
                                               value="@item.Quantity"
                                               class="form-control form-control-sm cart-quantity-input qty-input"
                                               data-cartitemid="@item.CartItemId"
                                               readonly />

                                        <button type="button" class="qty-btn qty-plus" data-cartitemid="@item.CartItemId">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Subtotal -->
                                <div class="cart-item-subtotal">
                                    <span class="subtotal-label">Tổng cộng:</span>
                                    <span class="subtotal-price">@((item.UnitPrice * item.Quantity).ToString("N0"))₫</span>
                                </div>

                                <!-- Remove Button -->
                                @* ✅ GIỮ NGUYÊN: Remove form với confirm *@
                                <form asp-controller="Cart" asp-action="Remove" method="post"
                                      onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?');"
                                      style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="cartItemId" value="@item.CartItemId" />
                                    <button type="submit" class="btn-remove" title="Xóa">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                </div>

                <!-- Continue Shopping Button -->
                <div class="mt-4">
                    <a asp-controller="Shop" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> Tiếp tục mua sắm
                    </a>
                </div>
            </div>

            <!-- Order Summary (Right Column) -->
            <div class="col-lg-4">
                <div class="order-summary sticky-top" style="top: 100px;">
                    <h4 class="summary-title">Tóm tắt đơn hàng</h4>

                    <div class="summary-row">
                        <span>Tạm tính:</span>
                        @* ✅ GIỮ NGUYÊN: cartTotal ID để JS update được *@
                        <span id="cartTotal">@((Model.CartItems.Sum(i => i.UnitPrice * i.Quantity)).ToString("N0"))₫</span>
                    </div>

                    <div class="summary-row">
                        <span>Phí vận chuyển:</span>
                        <span class="text-muted">Tính sau</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row summary-total">
                        <span>Tổng cộng:</span>
                        <span class="total-price">@((Model.CartItems.Sum(i => i.UnitPrice * i.Quantity)).ToString("N0"))₫</span>
                    </div>

                    <div class="summary-note">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Phí vận chuyển và chi tiết thanh toán sẽ được chọn ở trang thanh toán.</small>
                    </div>

                    <a asp-controller="Order" asp-action="Checkout" class="btn btn-checkout">
                        <i class="bi bi-lock-fill me-2"></i> Thanh toán
                    </a>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="trust-item">
                            <i class="bi bi-shield-check"></i>
                            <span>Thanh toán an toàn</span>
                        </div>
                        <div class="trust-item">
                            <i class="bi bi-truck"></i>
                            <span>Giao hàng nhanh</span>
                        </div>
                        <div class="trust-item">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>Đổi trả 30 ngày</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/cart.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        (function () {
            // Debounce helper
            function debounce(fn, delay) {
                let t;
                return function () {
                    const args = arguments;
                    clearTimeout(t);
                    t = setTimeout(function () { fn.apply(null, args); }, delay);
                };
            }

            // Format number with thousand separators
            function formatNumber(n) {
                return (n || 0).toLocaleString('en-US');
            }

            // ✅ FIXED: Recalculate total và update TẤT CẢ elements
            function recalcTotal() {
                const items = document.querySelectorAll('.cart-item');
                let sum = 0;

                items.forEach(item => {
                    const unitElement = item.querySelector('[data-unitprice]');
                    if (!unitElement) return;

                    // Parse unit price from data attribute (invariant format: 12345.67)
                    const unitPriceStr = unitElement.getAttribute('data-unitprice');
                    const unitPrice = parseFloat(unitPriceStr) || 0;

                    // Get quantity
                    const qtyInput = item.querySelector('.cart-quantity-input');
                    const qty = qtyInput ? (parseInt(qtyInput.value, 10) || 0) : 0;

                    // Calculate subtotal for this item
                    const subtotal = unitPrice * qty;
                    sum += subtotal;

                    // Update item subtotal display
                    const subtotalEl = item.querySelector('.subtotal-price');
                    if (subtotalEl) {
                        subtotalEl.textContent = formatNumber(subtotal) + '₫';
                    }
                });

                // ✅ UPDATE: Cập nhật CẢ HAI elements hiển thị tổng tiền
                // 1. Tạm tính trong summary
                const cartTotalEl = document.getElementById('cartTotal');
                if (cartTotalEl) {
                    cartTotalEl.textContent = formatNumber(sum) + '₫';
                }

                // 2. Tổng cộng cuối cùng (vì chưa tính shipping nên bằng tạm tính)
                const totalPriceEl = document.querySelector('.summary-total .total-price');
                if (totalPriceEl) {
                    totalPriceEl.textContent = formatNumber(sum) + '₫';
                }

                console.log('Total recalculated:', sum); // Debug log
            }

            // Get antiforgery token
            const tokenInput = document.querySelector('#afToken input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : null;
            if (!token) {
                console.error('Antiforgery token not found');
                return;
            }

            // Get all quantity inputs
            const inputs = document.querySelectorAll('.cart-quantity-input');
            if (!inputs.length) return;

            // ✅ IMPROVED: Send update to server
            async function sendUpdate(cartItemId, quantity, inputEl) {
                if (!cartItemId) return;
                if (quantity < 1) {
                    quantity = 1;
                    inputEl.value = 1;
                }

                const fd = new FormData();
                fd.append('cartItemId', cartItemId);
                fd.append('quantity', quantity);
                fd.append('__RequestVerificationToken', token);

                try {
                    const res = await fetch('@Url.Action("Update", "Cart")', {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin',
                        body: fd
                    });

                    if (!res.ok) throw new Error('Network error');

                    const contentType = res.headers.get('content-type') || '';
                    if (contentType.indexOf('application/json') !== -1) {
                        const data = await res.json();
                        if (data?.success) {
                            // Update input value từ server
                            if (data.quantity != null) {
                                inputEl.value = data.quantity;
                            }

                            // Update cart badge
                            const badge = document.getElementById('cartBadge');
                            if (badge && data.count != null) {
                                badge.textContent = data.count;
                                badge.style.display = (data.count > 0) ? 'block' : 'none';
                            }

                            // ✅ KEY FIX: Recalculate total NGAY SAU KHI update thành công
                            recalcTotal();

                            console.log('Cart updated successfully'); // Debug log
                        } else {
                            alert(data?.error ?? 'Không thể cập nhật số lượng');
                        }
                    } else {
                        // Fallback: reload page if response is HTML
                        location.reload();
                    }
                } catch (err) {
                    console.error('Update error:', err);
                    alert('Lỗi khi cập nhật giỏ hàng');
                }
            }

            // Debounced input handler
            const handler = debounce(function (e) {
                const input = e.target;
                const cartItemId = input.dataset.cartitemid;
                const qty = parseInt(input.value, 10) || 1;
                sendUpdate(cartItemId, qty, input);
            }, 600);

            // Attach input event listeners
            inputs.forEach(i => i.addEventListener('input', handler));

            // ✅ IMPROVED: Handle +/- button clicks
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.qty-btn');
                if (!btn) return;

                e.preventDefault();

                const cartItemId = btn.dataset.cartitemid;
                const itemElement = btn.closest('.cart-item');
                const input = itemElement ? itemElement.querySelector('.cart-quantity-input') : null;

                if (!input) return;

                let currentQty = parseInt(input.value, 10) || 1;
                let newQty = currentQty;

                if (btn.classList.contains('qty-plus')) {
                    newQty = currentQty + 1;
                } else if (btn.classList.contains('qty-minus')) {
                    newQty = Math.max(1, currentQty - 1);
                }

                if (newQty !== currentQty) {
                    input.value = newQty;

                    // ✅ IMPROVED: Update UI ngay lập tức trước khi gọi server
                    recalcTotal();

                    // Gửi request lên server
                    sendUpdate(cartItemId, newQty, input);
                }
            });

            // ✅ RUN ON LOAD: Tính tổng ngay khi load trang
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', recalcTotal);
            } else {
                recalcTotal();
            }
        })();
    </script>
}

