@model IEnumerable<BLL.DTOs.ProductViewModel>

@{
    ViewData["Title"] = "Cửa hàng";
}

<div class="bg-light py-4 mb-4">
    <div class="container text-center">
        <h1 class="fw-bold mb-0">Cửa hàng trực tuyến</h1>
        <p class="text-muted mb-0">Khám phá các sản phẩm công nghệ & thời trang mới nhất</p>
    </div>
</div>

<div class="container mb-5">
    <div class="row align-items-center mb-4 g-3">
        <div class="col-md-6 col-lg-5">
            <form asp-controller="Shop" asp-action="Index" method="get">
                <div class="input-group shadow-sm">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" name="searchTerm" class="form-control border-start-0 border-end-0"
                           placeholder="Bạn muốn tìm gì hôm nay?"
                           value="@ViewBag.CurrentFilter">

                    @if (!string.IsNullOrEmpty(ViewBag.CurrentFilter as string))
                    {
                        <a asp-action="Index" class="btn btn-white border border-start-0 text-danger" title="Xóa tìm kiếm">
                            <i class="bi bi-x-lg"></i>
                        </a>
                    }
                    <button class="btn btn-primary px-4" type="submit">Tìm</button>
                </div>
            </form>
        </div>

        <div class="col-md-auto ms-auto"></div>

        <div class="col-md-auto">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle shadow-sm w-100" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-sort-down me-1"></i> Sắp xếp theo
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item" href="#">Mới nhất</a></li>
                    <li><a class="dropdown-item" href="#">Giá: Thấp đến Cao</a></li>
                    <li><a class="dropdown-item" href="#">Giá: Cao đến Thấp</a></li>
                </ul>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(ViewBag.CurrentFilter as string))
    {
        <div class="mb-3">
            <span class="text-muted">Kết quả tìm kiếm cho: </span>
            <span class="fw-bold text-dark">"@ViewBag.CurrentFilter"</span>
            <span class="badge bg-secondary rounded-pill ms-2">@Model.Count() sản phẩm</span>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            @foreach (var item in Model)
            {
                <div class="col">
                    <div class="card h-100 border-0 shadow-hover product-card">
                        <div class="position-relative overflow-hidden bg-light ratio ratio-1x1 rounded-top">
                            <a asp-action="Details" asp-route-id="@item.ProductId"
                               class="position-absolute top-0 start-0 w-100 h-100" style="z-index:1;"></a>

                            @if (!string.IsNullOrEmpty(item.Image))
                            {
                                <img src="@item.Image" class="card-img-top object-fit-cover product-img w-100 h-100" alt="@item.ProductName">
                            }
                            else
                            {
                                <img src="https://placehold.co/400x400?text=No+Image" class="card-img-top object-fit-cover product-img w-100 h-100" alt="@item.ProductName">
                            }

                            <!-- ♥ Button NGOÀI a -->
                            <button class="position-absolute top-12px end-12px p-2 btn-link text-white shadow-lg rounded-circle wishlist-toggle z-index-5"
                                    data-product-id="@item.ProductId" title="Thêm Wishlist"
                                    style="background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border:none;width:44px;height:44px;display:flex;align-items:center;justify-content:center;transition:all .3s;z-index:5;">
                                <i class="bi bi-heart fs-5 wishlist-icon" style="transition:all .3s;"></i>
                            </button>
                        </div>


                        <!-- Card Body PHẢI nằm TRONG card -->
                        <div class="card-body d-flex flex-column p-3">
                            <div class="small text-muted mb-1 text-uppercase">@item.CategoryName</div>

                            <h5 class="card-title text-truncate mb-2">
                                <a asp-action="Details"
                                   asp-route-id="@item.ProductId"
                                   class="text-decoration-none text-dark product-title-link">
                                    @item.ProductName
                                </a>
                            </h5>

                            <div class="mt-auto">
                                <span class="fw-bold text-primary fs-5">@item.Price.ToString("N0") ₫</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5 bg-light rounded-3">
            <div class="mb-3">
                <i class="bi bi-search display-1 text-secondary opacity-50"></i>
            </div>
            <h4 class="fw-bold">Không tìm thấy sản phẩm nào</h4>
            <p class="text-muted">Hãy thử từ khóa khác hoặc xem danh mục phổ biến.</p>
            <a asp-controller="Shop" asp-action="Index" class="btn btn-outline-primary mt-2">
                Xem tất cả sản phẩm
            </a>
        </div>
    }
</div>
@section Scripts {
    <script>
        $(function() {
            console.log('jQuery ready, binding wishlist...');

            // ⭐ 1. LOAD STATE BAN ĐẦU (icon đỏ nếu đã add)
            $('.wishlist-toggle').each(async function() {
                const btn = this;
                const productId = btn.dataset.productId;
                try {
                    const res = await fetch(`/Wishlist/Check/${productId}`);
                    const isInWishlist = await res.json();
                    const icon = btn.querySelector('.wishlist-icon');

                    if (isInWishlist) {
                        icon.classList.remove('bi-heart', 'text-white');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                        btn.title = 'Xóa khỏi Wishlist';
                    }
                } catch(e) {
                    console.log(`Check wishlist ${productId} fail:`, e);
                }
            });

                    // 2. TOGGLE với API mới
            $(document.body).on('click', '.wishlist-toggle', async function(e) {
                e.preventDefault();
                e.stopPropagation();

                const btn = this;
                const icon = btn.querySelector('.wishlist-icon');
                const productId = btn.dataset.productId;

                console.log(`🧡 Toggle ${productId}`);

                btn.disabled = true;
                btn.style.opacity = '0.6';

                try {
                    // ⭐ THAY Add → Toggle + POST
                    const res = await fetch(`/Wishlist/Toggle/${productId}`, {
                        method: 'POST',
                        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
                    });

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    console.log('✅ Toggle response:', data);

                    if (data.success) {
                        // Toggle dựa vào isAdded từ server
                        if (data.isAdded) {
                            // Vừa ADD → đỏ
                            icon.classList.remove('bi-heart', 'text-white');
                            icon.classList.add('bi-heart-fill', 'text-danger');
                            btn.title = 'Xóa khỏi Wishlist';
                        } else {
                            // Vừa REMOVE → trắng
                            icon.classList.remove('bi-heart-fill', 'text-danger');
                            icon.classList.add('bi-heart', 'text-white');
                            btn.title = 'Thêm Wishlist';
                        }
                    } else {
                        alert(data.message || 'Lỗi toggle wishlist');
                    }
                } catch(err) {
                    console.error('❌ Error:', err);
                    alert('Lỗi kết nối!');
                } finally {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            });
        });
    </script>
}



<style>
    .z-index-5 {
        z-index: 5 !important;
    }
    .top-12px {
        top: 12px !important;
    }

    .end-12px {
        right: 12px !important;
    }

    .shadow-hover {
        transition: all 0.3s ease;
        border: 1px solid #eee !important;
    }

        .shadow-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12) !important;
            border-color: transparent !important;
        }

    .product-img {
        transition: transform 0.5s ease;
    }

    .shadow-hover:hover .product-img {
        transform: scale(1.08);
    }

    .wishlist-toggle:hover {
        background: rgba(255,255,255,0.35) !important;
        transform: scale(1.15);
    }

    .wishlist-toggle:active {
        transform: scale(0.95);
    }
</style>

