CREATE DATABASE ShopDB;
GO
USE ShopDB;
GO

-- ROLES
CREATE TABLE Roles (
    RoleId      INT IDENTITY PRIMARY KEY,
    RoleName    NVARCHAR(50) NOT NULL,
    Description NVARCHAR(255)
);

-- USERS
CREATE TABLE Users (
    UserId        INT IDENTITY PRIMARY KEY,
    RoleId        INT NOT NULL,
    UserName      NVARCHAR(50) NOT NULL UNIQUE,
    Email         NVARCHAR(100) NOT NULL UNIQUE,
    PasswordHash  NVARCHAR(255) NOT NULL,
    FullName      NVARCHAR(100),
    Phone         NVARCHAR(20),
    Address       NVARCHAR(255),  
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    IsActive      BIT NOT NULL DEFAULT 1,
    CONSTRAINT FK_Users_Roles FOREIGN KEY (RoleId) REFERENCES Roles(RoleId)
);

-- CATEGORIES
CREATE TABLE Categories (
    CategoryId   INT IDENTITY PRIMARY KEY,
    CategoryName NVARCHAR(100) NOT NULL,
    ParentId     INT NULL,
    Description  NVARCHAR(255),
    CONSTRAINT FK_Categories_Parent FOREIGN KEY (ParentId) REFERENCES Categories(CategoryId)
);

-- PRODUCTS
CREATE TABLE Products (
    ProductId     INT IDENTITY PRIMARY KEY,
    CategoryId    INT NOT NULL,
    ProductName   NVARCHAR(150) NOT NULL,
    SKU           NVARCHAR(50) UNIQUE,
    Description   NVARCHAR(MAX),
    Price         DECIMAL(18,2) NOT NULL,
    Status        TINYINT NOT NULL DEFAULT 1,   -- 1: Active
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt     DATETIME2 NULL,
    CONSTRAINT FK_Products_Categories FOREIGN KEY (CategoryId) REFERENCES Categories(CategoryId)
);

-- INVENTORIES
CREATE TABLE Inventories (
    InventoryId INT IDENTITY PRIMARY KEY,
    ProductId   INT NOT NULL,
    Quantity    INT NOT NULL DEFAULT 0,
    Warehouse   NVARCHAR(100),
    UpdatedAt   DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Inventories_Products FOREIGN KEY (ProductId) REFERENCES Products(ProductId)
);

-- CART
CREATE TABLE Cart (
    CartId     INT IDENTITY PRIMARY KEY,
    UserId     INT NOT NULL,
    CreatedAt  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt  DATETIME2 NULL,
    CONSTRAINT FK_Cart_Users FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

-- CART ITEMS
CREATE TABLE CartItem (
    CartItemId INT IDENTITY PRIMARY KEY,
    CartId     INT NOT NULL,
    ProductId  INT NOT NULL,
    Quantity   INT NOT NULL DEFAULT 1,
    UnitPrice  DECIMAL(18,2) NOT NULL,
    CONSTRAINT FK_CartItem_Cart FOREIGN KEY (CartId) REFERENCES Cart(CartId),
    CONSTRAINT FK_CartItem_Products FOREIGN KEY (ProductId) REFERENCES Products(ProductId)
);

-- ORDERS
CREATE TABLE Orders (
    OrderId      INT IDENTITY PRIMARY KEY,
    UserId       INT NOT NULL,
    OrderDate    DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    Status       NVARCHAR(30) NOT NULL,          -- Pending, Paid, Shipped, ...
    TotalAmount  DECIMAL(18,2) NOT NULL DEFAULT 0,
    Note         NVARCHAR(255),
    CONSTRAINT FK_Orders_Users FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

-- ORDER ITEMS
CREATE TABLE OrderItems (
    OrderItemId INT IDENTITY PRIMARY KEY,
    OrderId     INT NOT NULL,
    ProductId   INT NOT NULL,
    Quantity    INT NOT NULL,
    UnitPrice   DECIMAL(18,2) NOT NULL,
    CONSTRAINT FK_OrderItems_Orders FOREIGN KEY (OrderId) REFERENCES Orders(OrderId),
    CONSTRAINT FK_OrderItems_Products FOREIGN KEY (ProductId) REFERENCES Products(ProductId)
);

-- PAYMENTS
CREATE TABLE Payments (
    PaymentId     INT IDENTITY PRIMARY KEY,
    OrderId       INT NOT NULL,
    PaymentMethod NVARCHAR(50) NOT NULL,  -- COD, CreditCard, ...
    Amount        DECIMAL(18,2) NOT NULL,
    PaidAt        DATETIME2 NULL,
    Status        NVARCHAR(30) NOT NULL,  -- Pending, Paid, Failed
    CONSTRAINT FK_Payments_Orders FOREIGN KEY (OrderId) REFERENCES Orders(OrderId)
);

-- SHIPPING
CREATE TABLE Shipping (
    ShippingId    INT IDENTITY PRIMARY KEY,
    OrderId       INT NOT NULL,
    Address       NVARCHAR(255) NOT NULL,
    City          NVARCHAR(100),
    Country       NVARCHAR(100),
    PostalCode    NVARCHAR(20),
    Carrier       NVARCHAR(50),
    TrackingNumber NVARCHAR(100),
    ShippedDate   DATETIME2 NULL,
    DeliveryDate  DATETIME2 NULL,
    CONSTRAINT FK_Shipping_Orders FOREIGN KEY (OrderId) REFERENCES Orders(OrderId)
);

-- WISHLIST
CREATE TABLE Wishlist (
    WishlistId INT IDENTITY PRIMARY KEY,
    UserId     INT NOT NULL,
    ProductId  INT NOT NULL,
    CreatedAt  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Wishlist_Users FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT FK_Wishlist_Products FOREIGN KEY (ProductId) REFERENCES Products(ProductId)
);

-- REVIEWS
CREATE TABLE Reviews (
    ReviewId   INT IDENTITY PRIMARY KEY,
    UserId     INT NOT NULL,
    ProductId  INT NOT NULL,
    Rating     INT NOT NULL,             -- 1-5
    Comment    NVARCHAR(MAX),
    CreatedAt  DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Reviews_Users FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT FK_Reviews_Products FOREIGN KEY (ProductId) REFERENCES Products(ProductId)
);

CREATE TABLE RefreshTokens (
    RefreshTokenId INT IDENTITY PRIMARY KEY,
    UserId         INT NOT NULL,
    Token          NVARCHAR(255) NOT NULL, -- hoặc UNIQUEIDENTIFIER / VARCHAR(200)
    ExpiresAt      DATETIME2 NOT NULL,
    CreatedAt      DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    RevokedAt      DATETIME2 NULL,
    ReplacedByToken NVARCHAR(255) NULL,    -- dùng nếu bạn muốn rotate token
    IsRevoked      BIT NOT NULL DEFAULT 0,

    CONSTRAINT FK_RefreshTokens_Users FOREIGN KEY (UserId)
        REFERENCES Users(UserId)
);

